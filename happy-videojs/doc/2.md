# 空格键控制播放/暂停

本节，我们的目的是，扩展空格键控制播放/暂停的功能。最终效果跟 youtube 一致。

#### 引入插件

我们可以通过写自己的[插件](http://docs.videojs.com/docs/guides/plugins.html)来实现额外的功能。参考这篇文档，尝试如下：

**VideoPlayer.js**

```
··· ···
render () {
   // 写插件：当监听到播放器实例的播放（play）事件，就输出一条语句
   function examplePlugin(options) {
       this.on('play', function(e) {
         console.log('playback has started!');
       });
     };

   // 注册该插件
   videojs.registerPlugin('examplePlugin', examplePlugin)

   return (
     ··· ···
```


下面来使用

**CourseContainer.js**
```
··· ···
const CourseVideoJsOptions = {
  autoplay: false,
  controls: true,

  ... ...

  // 使用该插件
  plugins: {
    setStateandFocusPlugin: true
  }
}
... ...
```

完成以上步骤后，再次点开视频，发现控制台输出了 `playback has started!` ，说明插件应用成功。

关于代码中的事件监听，参考文档 [Event Target](http://docs.videojs.com/tutorial-event-target.html)

#### 设置播放器实例的状态

在插件代码中加一条 console 语句如下。

如此，在控制台中，就可以在点开视频时看到，这句代码输出了该播放器的实例对象

**VideoPlayer.js**
```
··· ···
function examplePlugin(options) {
    this.on('play', function(e) {
      console.log(this)
      console.log('playback has started!')
    });
  };
  ... ...
```

仔细查看该对象的属性，发现有 `setState` 和 `state` 两条。
据此，我们尝试根据播放器的播放状态来设置 `state` 值

注意，这和 React 组件的 state 是两回事。

**VideoPlayer.js** 中默认播放播放，跟 Youtube 保持一致

```
state = {
  isPlaying: true
}

let that = this # 插件呼叫的时候 this 作用域另有所指，所以要把当前 class 对象保存到 that 中方便使用

this.on('play', function (e) {
  console.log('playback has started!')
  that.setState({
    isPlaying: true
  })
})

this.on('pause', function (e) {
  console.log('playback has paused')
  that.setState({
    isPlaying: false
  })
})
... ...
```

此时，再让视频播放/暂停，都会看到控制台输出的状态，说明设置成功。

#### 初步改进空格键的功能

可以使用 [onKeyDown 事件](https://reactjs.org/docs/events.html#keyboard-events)，它会在用户按下一个键盘按键时发生。

空格键的键码是32。


通过 onKeyDown 事件 <video> 标签不支持，所以我们把它写在包裹 <video> 标签的 <div> 标签中。代码如下

**VideoPlayer.js**

```
··· ···
videojs.registerPlugin('setStateandFocusPlugin', setStateandFocusPlugin)
// videojs.registerPlugin('handleKeyPress', handleKeyPress)

return (
  <div data-vjs-player
    onKeyDown={this.handleSpaceKeyDown}
    >
    <video
    ref={node => this.videoNode = node}
    className='video-js vjs-hqcat'
    />
    </div>
    )
  }
}
```

接下来写监听到 onKeyDown 事件后调用的函数：
  * 如果视频正在播放中，则暂停视频
  * 如果视频正在暂停中，则继续播放视频

**VideoPlayer.js**
```
··· ···
componentWillUnmount () {
  if (this.player) {
    this.player.dispose()
  }
}

  handleKeyDown = event => {
    if (event.which === 32) {
      event.preventDefault()
      if (this.player) {
        switch (this.state.isPlaying) {
          case true:
            this.player.pause()
            break
          case false:
            this.player.play()
            break
          default: return
        }
      } else {
        console.log('error')
      }
    }
  }

... ...
```

至此，我们完成了初步的改进。但目前扔有一些问题：
* 点击视频播放后，必须再点一下视频，才能用空格键控制暂停/播放；

下一步改进焦点管理

元素获得焦点的可以用代码中调用 `focus()` 方法。相应的节点获得了焦点，onKeyDown被触发。

下面来在视频播放的时候，调用 `focus()` 方法，使得播放器获得焦点。

如何获取播放器的 DOM 元素？可以使用 React 的 ref。
参考 [Refs and the DOM](https:// React js.org/docs/refs-and-the-dom.html)

如何在插件代码中获取 React 组件？可以从它的外部传 `this` 进去。

尝试改进代码：

**VideoPlayer.js**
```
··· ···
render () {
  // write a plugin
  var that = this
  const togglePlay = function (options) {
    this.on('play', function (e) {
      console.log('playback has started!')
      // 控制焦点
      that.refs.videoPlayerRef.focus()
    })
    ... ...
    return (
      <div data-vjs-player
        onKeyDown={this.handleSpaceKeyDown}
        ref='videoPlayerRef'
        >
        <video
          ref={node => this.videoNode = node}
          className='video-js vjs-hqcat'
        />
      </div>
    )
  }
}
```

现在再试用播放器，可以发现第一个问题已经解决了。点开视频后，直接按空格键，视频暂停。




这样达成的效果是：

- 页面打开直接播放，同时触发 focus() 语句让，绑定 onKeyDown 的 div 获得焦点
- 获得焦点除了使用 focus 还可以是鼠标点击，所以入股用户点击播放器之外的其他位置，onKeyDown 也就监听不到了，不过这个跟 youtube 上是一样的效果。监听范围太广会影响其他功能，例如发评论。
