
### 5-写插件(Plugin)扩展功能

本节，我们的目的是，扩展空格键控制播放/暂停的功能。

 video.js 的默认动作是，仅仅在 control bar 的播放键被鼠标选中时，才能用空格/回车键控制播放/暂停。不太方便。
我们要将其改进为：点开视频后，就可以通过空格键控制视频的播放/暂停。

#### 引入插件

我们可以通过写自己的[插件](http://docs.videojs.com/docs/guides/plugins.html)来实现额外的功能。参考这篇文档，尝试如下：

**VideoPlayer.js**

```
··· ···
render () {
   // 写插件：当监听到播放器实例的播放（play）事件，就输出一条语句
   function examplePlugin(options) {
       this.on('play', function(e) {
         console.log('playback has started!');
       });
     };

   // 注册该插件
   videojs.registerPlugin('examplePlugin', examplePlugin)

   return (
     ··· ···
```


下面尝试使用

**CourseContainer.js**
```
··· ···
const CourseVideoJsOptions = {
  autoplay: false,
  controls: true,

  ... ...

  // 使用该插件
  plugins: {
    setStateandFocusPlugin: true
  }
}
... ...
```

完成以上步骤后，再次点开视频，发现控制台输出了 `playback has started!` ，说明插件应用成功。

关于代码中的事件监听，参考文档 [Event Target](http://docs.videojs.com/tutorial-event-target.html)

#### 设置播放器实例的状态

在插件代码中加一条 console 语句如下。

如此，在控制台中，就可以在点开视频时看到，这句代码输出了该播放器的实例对象

**VideoPlayer.js**
```
··· ···
function examplePlugin(options) {
    this.on('play', function(e) {
      console.log(this)
      console.log('playback has started!')
    });
  };
  ... ...
```

仔细查看该对象的属性，发现有 `setState` 和 `state` 两条。
据此，我们尝试根据播放器的播放状态来设置 `state` 值

注意，这和 React 组件的 state 是两回事。

**VideoPlayer.js**
```
··· ···
this.on('play', function (e) {
  console.log(this);
  console.log('playback has started!')
  this.setState({
    state: 'playing'
  })
  console.log(this.state.state)
})

this.on('pause', function (e) {
  console.log('playback has paused')
  this.setState({
    state: 'pause'
  })
  console.log(this.state.state)
})
... ...
```

此时，再让视频播放/暂停，都会看到控制台输出的状态，说明设置成功。

#### 初步改进空格键的功能

空格键的默认动作是:

这样既麻烦又不实用，因为只有“播放/暂停”功能才是使用频率最高的功能。让空格键在任何情况下都能直接控制暂停功能，可以明显提升用户体验。

接下来，我们需要监听“按下空格键”这个事件。这个需求可以分为两步：
  * 监听键盘事件
  * 判断是否为空格键

对于前者，我们可以使用 [onKeyDown 事件](http://www.w3school.com.cn/jsref/event_onkeydown.asp)，它会在用户按下一个键盘按键时发生。

对于后者，涉及到 [keyCode/键码-文档链接待补充]()的知识。具体到这个案例，空格键的键码是32。

推荐[这个网站](http://keycode.info)，它可以很方便地查询键盘各个按键的键码，十分好用。

通过 onKeyDown 事件的文档可以看到，<video> 标签不支持它，所以我们把它写在包裹 <video> 标签的 <div> 标签中。代码如下

**VideoPlayer.js**

```
··· ···
videojs.registerPlugin('setStateandFocusPlugin', setStateandFocusPlugin)
// videojs.registerPlugin('handleKeyPress', handleKeyPress)

return (
  <div data-vjs-player
    onKeyDown={this.handleSpaceKeyDown}
    >
    <video
    ref={node => this.videoNode = node}
    className='video-js vjs-hqcat'
    />
    </div>
    )
  }
}
```

由于 JS 的[事件冒泡-文档链接待补充]()机制，onKeyDown 事件是可以成功捕获的。

事实上，如果在目前这个 div 标签的外层再套一层 div ，外层的 div 也同样能够捕获 onKeyDown 事件，有兴趣的可以试一下。

接下来写监听到 onKeyDown 事件后调用的函数：

* 首先，我们需要判断是否为空格键。
* 如果是，我们需要禁止原来默认的动作。
* 然后，利用之前设置的视频播放状态，进行相应的操作：
  * 如果视频正在播放中，则暂停视频
  * 如果视频正在暂停中，则继续播放视频

**VideoPlayer.js**
```
··· ···
componentWillUnmount () {
  if (this.player) {
    this.player.dispose()
  }
}

handleSpaceKeyDown = (event) => {
  // 判断是否为空格键
  if (event.which === 32) {
    event.preventDefault()
    if (this.player) {
      // 根据播放状态的不同，进行相应的操作
      switch (this.player.state.state) {
        case 'playing':
        this.player.pause()
        break
        case 'pause':
        this.player.play()
        break
        default: return
      }
    } else {
      console.log('error')
    }
  }
}
... ...
```

至此，我们完成了初步的改进。但目前扔有一些问题：
* 点击视频播放后，必须再点一下视频，才能用空格键控制暂停/播放；
* 如果在播放时，鼠标点一下页面上的其他地方，空格键又失效了。

下一步改进焦点管理

元素获得焦点的方式有页面加载、用户输入（通常是通过 Tab 按键）和在代码中调用 `focus()` 方法。相应的文档获得了焦点，用户才能与页面交互。

于是，我们是思路是：当视频播放时，调用 `focus()` 方法，使得播放器获得焦点。

如何获取播放器的 DOM 元素？可以使用 React 的 ref。
参考 [Refs and the DOM](https:// React js.org/docs/refs-and-the-dom.html)

如何在插件代码中获取 React 组件？可以从它的外部传 `this` 进去。

尝试改进代码：

**VideoPlayer.js**
```
··· ···
render () {
  // write a plugin
  var that = this
  const setStateandFocusPlugin = function (options) {
    this.on('play', function (e) {
      console.log('playback has started!')

      // 控制台输出结果表明成功获取VideoPlayer组件
      console.log(that)

      this.setState({
        state: 'playing'
      })
      // 控制焦点
      that.refs.videoPlayerRef.focus()
    })
    ... ...
    return (
      <div data-vjs-player
        onKeyDown={this.handleSpaceKeyDown}
        ref='videoPlayerRef'
        >
        <video
          ref={node => this.videoNode = node}
          className='video-js vjs-hqcat'
        />
      </div>
    )
  }
}
```

现在再试用播放器，可以发现第一个问题已经解决了。点开视频后，直接按空格键，视频暂停。


空格键控制播放/暂停的功能就比较完善了。
