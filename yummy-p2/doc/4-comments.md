# 添加评论功能

欢迎来到新的一节《添加评论功能》。前端后端整个走一个基本功能开发流程。

### 先写界面

进入下一部分《先写界面》。美观的界面先出来，后面眼睛会比较愉悦一些。

先列出已有评论。

list-comments----

首先在 DishCommentItem 中完成一条评论显示的基本样式，其中要显示用户头像，所以到 ApiConstants 里面定义了 avavtarUrl 也就是头像链接，最后在 DishComments 组件里面调用 DishCommentItem ，先使用临时的假数据，然后逆序显示。

添加评论 Form 。

comment-form----

表单里面做出一个受控组件的效果，然后到 DishComments 中导入一下，因为评论是逆序显示的，所以这里正好评论框就放在评论列表之上。

看看本部分达成的效果。界面上看一下，样式都有了。
至此，《先写界面》这部分就胜利完成了。

### 后端添加评论种子数据

每一条评论数据都不仅仅是有自己的 _id 和 content ，还应该有是谁，也就是 User ，在哪个甜点，也就是 dish 上， 发布的。

先到服务器，添加 comment 的数据模型文件

comment-model

可以看到，保存的数据不仅仅是评论内容 content ，还有 user 和 dish 的 id ，用来建立当前数据和另外两类数据的关联。

再到 controller 中定义获取所有评论接口

all-api----

在取出所有评论数据的时候，同时添加进来了 user 和 dish 的相关字段，包含用户的 username 和 avatar ，也就是用户名和头像，还有 dish ，也就是甜点的 poster 海报。

再来定义种子数据接口。

seed-api---

上面的 dish 和 user 的 id 值都是通过 postman 请求之前定义好的用户和甜点数据接口而得到的。同时注意 _id 一项就不用写了，因为保存到数据库的时候会自动生成这一项。

最后添加路由

router----

分别为读取所有评论，和填充种子数据两个接口设置了路由。

看一下本部分达成的最终效果。到 postman 中先去请求一下种子接口，看到返回填充数据库成功字样，接下来去请求所有评论信息，返回的数据中仔细观察，发现 user 和 dish 的相关信息，也就是之前我们在 populate 接口中填写的各项信息都返回了，但是 user.avatar 也就是用户头像一项没有返回，这个是因为数据库中 avatar 一项为空造成的，属于正常现象。

至此，《后端添加评论种子数据》这部分就胜利结束了。

### 读取评论

进入下一部分《读取评论》。把服务器端的真实数据读取到 redux 中。

老套路，添加 action/selector/reducer 进来

fetchComments---

跟之前读取所有甜点数据是完全一样的，这里就不重复啰嗦了。

数据到了前端，下一步是去展示这些数据。

show-detail---

也一样是跟 dish 一样的过程，先定义 selector 然后 container 中通过 selector 拿到数据，交给展示组件去显示到界面上。其中稍微复杂点的就是按照 dish 的 id ，对所有评论做了分组，存放到了 commentsByDishId 这个变量中了。

看看本部分达成的效果。页面中已经能显示真实的用户名，和评论内容了，如果未来我们上传头像功能开发完毕，这里的头像也应该可以显示真实的头像了。

至此，《读取评论》这部分就胜利完成了。

###  使用 momentjs 调整时间格式

进入下一部分《使用 momentjs 调整时间格式》。把评论的发布时间显示出来。

moment---

看看本部分达成的效果。页面上的时间就变成中文的多久以前了。
至此，《使用 momentjs 调整时间格式》这部分就胜利完成了。


### 添加评论

进入下一部分《添加评论》。把评论内容保存到数据库中。

添加 API 。

add-api---

保存评论之后，要返回评论的详细信息供前端使用，这条评论的信息要用来更新 redux 中保存的所有评论数组，所以这里的数据结构务必要和读取所有评论的时候的每一条评论一样。

用 postman 测试一下接口，发送 POST /commment 请求，header 填写 ContentType: application/json ，发送 body 选 raw 格式

```
{
   "content": "非常好吃",
    "dish": "5a26738e8ed6687f81859d24",
    "user": "5a2638f58b8b05037aed5007"
}
```

点发送可以看到保存成功的信息，证明接口工作正常了。

下面回到前端代码。写 action/reducer 代码。

add-comment----

评论提交后请求后端接口，把数据保存到数据库中，同时后端返回的完整的 comment 数据又被前端拿到保存到了所有评论数组中，所以界面可以自动更新看到新评论。

看看这部分达成的效果。页面中添加评论，如果不填写内容，就会看到提示信息，填写内容之后，可以成功的发布评论。

至此《添加评论》这部分就胜利结束了。

### 结语

进入最后一部分《结语》

复盘一下本节思路。先用一些临时数据，把前端界面写好，然后开发后端 API 的时候依然是先用种子数据填充数据库，这样就可以首先完成读数据的相关功能，最后在添加发评论的写操作，这样原本复杂的步骤就被拆成了几个简单步骤来完成了。

至此，《添加评论功能》这个小节就胜利完成了。

同时，本小节也是第一章《制作非电商和社交但是很实用的各项功能》的最后一个小节，到这里第一章就全部结束了。
